<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel Financiero</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* --------- ESTILO GENERAL --------- */
:root {
  --color-azul: #2563eb;
  --color-azul-oscuro: #1e3a8a;
  --color-fondo: #f9fafc;
  --color-texto: #333;
  --color-fondo-oscuro: #111827;
  --color-card-oscuro: #1f2937;
  --color-texto-oscuro: #e5e7eb;
  --color-hover: #1e40af;
}
body {
  font-family: "Segoe UI", sans-serif;
  background-color: #f9fafc;
  margin: 0;
  padding: 0 30px;
  color: #333;
  transition: background 0.3s, color 0.3s;
}
h1, h2 {
  color: #2563eb;
  margin-bottom: 10px;
}
.dark-mode h1, h2 {
  color: #93c5fd;
  margin-bottom: 10px;
}
button {
  background: #2563eb;
  color: white;
  border: none;
  padding: 8px 14px;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.3s;
}
button:hover {
  background: #1d4ed8;
}

/* --------- MEN√ö SUPERIOR --------- */
.navbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: white;
  padding: 15px 25px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  border-radius: 0 0 10px 10px;
  margin-bottom: 25px;
  position: sticky;
  top: 0;
  z-index: 10;
}
.nav-links {
  display: flex;
  gap: 20px;
}
.nav-links a {
  color: #2563eb;
  font-weight: 500;
  text-decoration: none;
  position: relative;
  transition: color 0.3s;
}
.nav-links a::after {
  content: "";
  position: absolute;
  left: 0;
  bottom: -4px;
  width: 0%;
  height: 2px;
  background: #2563eb;
  transition: width 0.3s;
}
.nav-links a:hover {
  color: #1e40af;
}
.nav-links a:hover::after {
  width: 100%;
}
.nav-links .sidebar-toggle {
  background: none;
  border: none;
  color: #2563eb;
  font-weight: 500;
  cursor: pointer;
  position: relative;
  padding: 0;
  font-size: 1rem;
  transition: color 0.3s;
}

.nav-links .sidebar-toggle::after {
  content: "";
  position: absolute;
  left: 0;
  bottom: -4px;
  width: 0%;
  height: 2px;
  background: #2563eb;
  transition: width 0.3s;
}

.nav-links .sidebar-toggle:hover {
  color: #1e40af;
}

.nav-links .sidebar-toggle:hover::after {
  width: 100%;
}

/* Para modo oscuro */
.dark-mode .nav-links .sidebar-toggle {
  color: #93c5fd;
}

.dark-mode .nav-links .sidebar-toggle:hover {
  color: #bfdbfe;
}

.dark-mode .nav-links .sidebar-toggle::after {
  background: #93c5fd;
}
/* SIDEBAR */
.sidebar {
  width: 250px;
  background: var(--color-azul-oscuro);
  color: white;
  position: fixed;
  top: 0;
  left: -250px;
  height: 100vh;
  padding-top: 60px;
  transition: left 0.3s ease;
  z-index: 100;
}
.sidebar.active { left: 0; }
.sidebar h2 { text-align: center; margin-bottom: 20px; font-size: 1.3em; }
.sidebar ul { list-style: none; padding: 0; }
.sidebar ul li { padding: 12px 20px; }
.sidebar ul li a { color: white; text-decoration: none; display: flex; align-items: center; gap: 12px; border-radius: 6px; transition: background 0.3s; }
.sidebar ul li a:hover { background: var(--color-azul); }

/* --------- TARJETAS KPI --------- */
.kpi-container {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  justify-content: center;
  margin-bottom: 30px;
}
.kpi-card {
  background: white;
  flex: 1;
  min-width: 200px;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  text-align: center;
  transition: transform 0.2s;
}
.kpi-card:hover {
  transform: translateY(-4px);
}
.kpi-card h3 {
  font-size: 0.95rem;
  color: #6b7280;
}
.kpi-card p {
  font-size: 1.4rem;
  color: #2563eb;
  font-weight: bold;
}

/* --------- GR√ÅFICAS --------- */
#graficas-container {
  display: flex;
  flex-wrap: wrap;
  gap: 30px;
  justify-content: center;
  margin-bottom: 40px;
}

/* --------- FORMULARIOS --------- */
form {
  background: white;
  padding: 15px;
  border-radius: 10px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  margin-bottom: 20px;
}
select, input {
  padding: 6px;
  border-radius: 6px;
  border: 1px solid #ccc;
  margin-right: 10px;
}
.toggle {
  color: #2563eb;
  cursor: pointer;
  font-size: 0.9rem;
  margin-left: 8px;
}

/* --------- TABLA --------- */
.table-container {
  width: 100%;
  max-height: 70vh;
  overflow-x: auto;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 10px;
  background: white;
  box-shadow: 0 1px 4px rgba(0,0,0,0.1);
}
table {
  width: 100%;
  border-collapse: collapse;
  min-width: 1400px;
}
th, td {
  padding: 6px 8px;
  text-align: right;
  border-bottom: 1px solid #ddd;
  white-space: nowrap;
}
th {
  background: #f1f5f9;
  text-align: center;
  position: sticky;
  top: 0;
  z-index: 2;
}
tr:hover {
  background-color: #c2d9ff;
}
.dark-mode tr:hover {
  background-color: #374151; 
}

/* --------- BOTONES EDITAR/ELIMINAR --------- */
.btn-edit, .btn-delete {
  background: none;
  border: none;
  cursor: pointer;
  padding: 4px;
  font-size: 1.1em;
}
.btn-edit i { color: #2563eb; }
.btn-edit:hover i { color: #1e40af; }
.btn-delete i { color: #dc2626; }
.btn-delete:hover i { color: #991b1b; }

/* --------- MODO OSCURO --------- */
.dark-mode {
  background-color: #111827;
  color: #e5e7eb;
}
.dark-mode .navbar {
  background: #1f2937;
  box-shadow: 0 2px 8px rgba(0,0,0,0.5);
}
.dark-mode .nav-links a {
  color: #93c5fd;
}
.dark-mode form,
.dark-mode .kpi-card,
.dark-mode .table-container {
  background: #1f2937;
  border-color: #374151;
}
.dark-mode th {
  background: #374151;
  color: #e5e7eb;
}
.dark-mode button {
  background: #4f46e5;
}
.dark-mode button:hover {
  background: #4338ca;
}
.dark-mode .sidebar {
  background: #1f2937;
  color: var(--color-texto-oscuro);
  box-shadow: 2px 0 8px rgba(0,0,0,0.5);
}
.dark-mode .sidebar ul li a { color: var(--color-texto-oscuro); }
.dark-mode .sidebar ul li a:hover { background: #4f46e5; }
</style>

<script>
// ---- Persistencia modo oscuro ----
document.addEventListener("DOMContentLoaded", () => {
  const body = document.body;
  const saved = localStorage.getItem("darkMode");
  const isDark = saved === "true";
  
  if (isDark) {
    body.classList.add("dark-mode");
    updateDarkModeButton(true);
  }
  
  // Forzar actualizaci√≥n de gr√°ficas despu√©s de un breve delay
  setTimeout(() => {
    window.dispatchEvent(new Event('resize'));
  }, 100);
});

function toggleDarkMode() {
  const body = document.body;
  const isDark = body.classList.toggle("dark-mode");
  
  localStorage.setItem("darkMode", isDark);
  updateDarkModeButton(isDark);
  
  // Disparar evento personalizado para que las gr√°ficas se actualicen
  window.dispatchEvent(new CustomEvent('darkModeToggle', { detail: isDark }));
}

function updateDarkModeButton(isDark) {
  const button = document.querySelector('.dark-mode-toggle');
  if (button) {
    button.textContent = isDark ? '‚òÄÔ∏è Modo Claro' : 'üåô Modo Oscuro';
    button.title = isDark ? 'Cambiar a modo claro' : 'Cambiar a modo oscuro';
  }
}
</script>

</head>
<body>
{% load humanize %}
<!--  MEN√ö SUPERIOR -->
<div class="navbar">
  <h1><i class="fa-solid fa-chart-line"></i> Panel Financiero</h1>
  <div class="nav-links">
    <a href="{% url 'historial_movimientos' %}"><i class="fa-solid fa-clock-rotate-left"></i> Historial de Movimientos</a>
    <a href="#" onclick="toggleDarkMode()"><i class="fas fa-moon"></i> Modo Oscuro</a>
    <!-- Bot√≥n del sidebar -->
    <button class="sidebar-toggle" id="btnSidebar" style="display:flex; align-items:center; gap:6px;">
      <i class="fas fa-bars"></i> Men√∫
    </button>
  </div>
</div>

<!-- SIDEBAR -->
<div class="sidebar" id="sidebar">
  <h2>Opciones</h2>
  <ul>
    <li><a href="#"><i class="fas fa-user"></i> Perfil</a></li>
    <li><a href="#"><i class="fas fa-cog"></i> Configuraci√≥n</a></li>
    <li><a href="#"><i class="fas fa-sign-out-alt"></i> Cerrar sesi√≥n</a></li>
  </ul>
</div>

<!--  FILTROS  -->
<!-- FILTROS --> <center> <form method="get" action=""> <label>Desde:</label> <select name="inicio"> <option value="">Todos</option> {% for p in periodos %} <option value="{{ p }}" {% if request.GET.inicio == p %}selected{% endif %}>{{ p }}</option> {% endfor %} </select> <label>Hasta:</label> <select name="fin"> <option value="">Todos</option> {% for p in periodos %} <option value="{{ p }}" {% if request.GET.fin == p %}selected{% endif %}>{{ p }}</option> {% endfor %} </select> <button type="submit">Filtrar</button> </form> </center>
<!-- üîπ TARJETAS KPI -->
<div class="kpi-container">
  <div class="kpi-card">
    <h3>Total Mantenimiento</h3>
    <p>${{ total_mantenimiento|floatformat:2|intcomma }}</p>
  </div>
  <div class="kpi-card">
    <h3>Total DPPP</h3>
    <p>${{ total_dppp|floatformat:2|intcomma }}</p>
  </div>
  <div class="kpi-card">
    <h3>Total Netos Mantenimiento</h3>
    <p>${{ total_netos|floatformat:2|intcomma }}</p>
  </div>
  <div class="kpi-card">
    <h3>Promedio Diferencia (Fact. vs Cobrado)</h3>
    <p>${{ promedio_diferencia|floatformat:2|intcomma }}</p>
  </div>
</div>


<!-- üîπ GR√ÅFICAS -->
<div id="graficas-container">
  <div class="grafica-card">
    <canvas id="graficaBarras"></canvas>
  </div>
  <div class="grafica-card">
    <canvas id="graficaBarrasHorizontales"></canvas>
  </div>
  <div class="grafica-card">
    <canvas id="graficaDiferencia"></canvas>
  </div>
</div>

<!-- üìä SCRIPT DE GR√ÅFICAS -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const registros = JSON.parse('{{ registros_json|safe|escapejs }}');

  // ---- CAMPOS Y ETIQUETAS ----
  const campos = [
    "ingresos_mantenimiento",
    "dppp",
    "ingresos_netos_mantenimiento",
    "ingresos_cuota_extraordinaria",
    "cuota_ordinaria_retroactiva",
    "revision_csau",
    "depositos_garantia_obra",
    "ingresos_intereses_cuotas",
    "ingresos_rendimiento_inversiones",
    "sanciones",
    "recuperacion_seguro_danios",
    "recuperacion_gastos_cobranza",
    "depositos_no_identificados"
  ];
  const etiquetas = [
    "Mantenimiento","DPPP","Netos Mantenimiento","Cuota Extraordinaria","Cuota Retroactiva",
    "Revisi√≥n CSAU","Garant√≠a Obra","Intereses Cuotas","Rendimiento Inversiones",
    "Sanciones","Seguro/Da√±os","Cobranza","No Identificados"
  ];

  // ---- CALCULAR TOTALES ----
  const totales = campos.map(campo => registros.reduce((a,b) => a + (parseFloat(b[campo])||0), 0));

  // ---- DIFERENCIA FACTURADO VS COBRADO ----
  const periodos = registros.map(r => r.periodo);
  const diferencias = registros.map(r => parseFloat(r.diferencia_ingresos_fac_vs_cobrados) || 0);

  // ---- GR√ÅFICA DE BARRAS ----
  new Chart(document.getElementById("graficaBarras"), {
    type: "bar",
    data: {
      labels: etiquetas,
      datasets: [{
        label: "Totales por tipo de ingreso",
        data: totales,
        backgroundColor: "#2563eb"
      }]
    },
    options: {
      responsive: true,
      plugins: {
        title: { display: true, text: "Totales por Categor√≠a" },
        legend: { display: false }
      },
      scales: { y: { beginAtZero: true } }
    }
  });

  // ---- GR√ÅFICA DE BARRAS HORIZONTALES ----
  new Chart(document.getElementById("graficaBarrasHorizontales"), {
    type: "bar",
    data: {
      labels: etiquetas,
      datasets: [{
        label: "Totales por tipo de ingreso",
        data: totales,
        backgroundColor: [
          "#2563eb","#1d4ed8","#3b82f6","#60a5fa","#93c5fd",
          "#eab308","#facc15","#fcd34d","#a3e635","#10b981",
          "#14b8a6","#8b5cf6","#ec4899"
        ]
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      plugins: {
        title: { display: true, text: "Distribuci√≥n Horizontal de Ingresos" },
        legend: { display: false }
      },
      scales: { x: { beginAtZero: true } }
    }
  });

  // ---- GR√ÅFICA DE DIFERENCIAS ----
  const ctxDif = document.getElementById("graficaDiferencia").getContext("2d");

  // Crear degradado vertical suave
  const grad = ctxDif.createLinearGradient(0, 0, 0, ctxDif.canvas.height);
  grad.addColorStop(1, "rgb(255, 0, 0, 0.6)");   // rojo suave
  grad.addColorStop(0.5, "rgb(163, 255, 0, 0.6"); // transici√≥n naranja
  grad.addColorStop(0, "rgb(163, 255, 0, 0.3)");   // verde suave

  new Chart(ctxDif, {
    type: "line",
    data: {
      labels: periodos,
      datasets: [{
        label: "Diferencia Facturado vs Cobrado",
        data: diferencias,
        borderColor: "#3c3c3c",
        backgroundColor: grad,
        tension: 0.3,
        fill: true,
        pointRadius: 4,
        pointHoverRadius: 6
      }]
    },
    options: {
      responsive: true,
      plugins: {
        title: { display: true, text: "Tendencia de Diferencia por Periodo" },
        legend: { display: true }
      },
      scales: { 
        y: { 
          beginAtZero: false,  // permite ver diferencias negativas y positivas
          ticks: { color: "#e5e7eb" } // para modo oscuro se vea
        },
        x: {
          ticks: { color: "#e5e7eb" } // para modo oscuro
        }
      }
    }
  });
});
</script>

<!-- üé® ESTILOS -->
<style>
#graficas-container {
  display: flex;
  gap: 25px;
  margin-top: 40px;
  flex-wrap: nowrap;
  overflow-x: auto;
}

.grafica-card {
  background: white;
  border-radius: 15px;
  padding: 20px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  min-width: 350px;
  flex: 1;
  transition: transform 0.2s;
}
.grafica-card:hover {
  transform: translateY(-4px);
}

/* MODO OSCURO */
.dark-mode #graficas-container .grafica-card {
  background: #1f2937;
  box-shadow: 0 4px 15px rgba(0,0,0,0.5);
}
</style>

<!-- üîπ FORMULARIO PARA A√ëADIR MOVIMIENTOS -->
<h2>A√±adir Movimiento</h2>
<button type="button" class="toggle-btn" onclick="toggleForm()">
  <i class="fas fa-plus"></i> A√±adir Movimiento
</button>

<form method="POST" id="form-movimiento" style="display:none; margin-top:10px;">
  {% csrf_token %}
  <p>{{ form.periodo.label_tag }} {{ form.periodo }}</p>
  
  <p class="toggle" onclick="document.getElementById('nuevo-periodo').style.display = 
       document.getElementById('nuevo-periodo').style.display === 'none' ? 'block' : 'none'">
    <i class="fas fa-calendar-plus"></i> Nuevo periodo
  </p>
  <div id="nuevo-periodo" style="display:none; margin-left:15px;">
    <p>{{ form.nuevo_periodo.label_tag }} {{ form.nuevo_periodo }}</p>
  </div>
  
  <p>{{ form.columna.label_tag }} {{ form.columna }}</p>
  <p>{{ form.monto.label_tag }} {{ form.monto }}</p>
  <button type="submit" name="a√±adir"><i class="fas fa-plus"></i> A√±adir</button>
</form>

<p style="color:green;">{{ mensaje }}</p>

<script>
function toggleForm() {
  const form = document.getElementById('form-movimiento');
  form.style.display = (form.style.display === 'none' ? 'block' : 'none');
}
</script>

<style>
.toggle-btn {
  background: #2563eb;
  color: white;
  border: none;
  padding: 8px 14px;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.3s;
}
.toggle-btn:hover {
  background: #1d4ed8;
}
</style>

<!-- üîπ FORMULARIO PARA REPORTE -->
<h2>Generar Reporte Excel</h2>
<form method="POST">
  {% csrf_token %}
  <label>Inicio:</label>
  <select name="inicio" required>
    {% for p in periodos %}<option>{{ p }}</option>{% endfor %}
  </select>
  <label>Fin:</label>
  <select name="fin" required>
    {% for p in periodos %}<option>{{ p }}</option>{% endfor %}
  </select>
  <button type="submit" name="generar_reporte"><i class="fas fa-file-excel"></i> Descargar</button>
</form>

<!-- üîπ TABLA DE REGISTROS -->
<h2>Registros Actuales</h2>
<div class="table-container">
  <table>
    <tr>
      <th>Periodo</th>
      <th>Ingresos x Mant.</th>
      <th>DPPP</th>
      <th>Ingresos Netos x Mant.</th>
      <th>Ingreso x Cuota Extr.</th>
      <th>Cuota ordinaria retroactiva</th>
      <th>Revision CSAU</th>
      <th>Dep√≥sitos en garantia de obra</th>
      <th>Ingresos x Intereses de Cuotas</th>
      <th>Ingresos x Rend. Inv.</th>
      <th>Sanciones</th>
      <th>Recuperaci√≥n de Seguro/da√±os</th>
      <th>Recuperaci√≥n de gastos por Cobranza via legal</th>
      <th>Depositos no Identif.</th>
      <th>Total</th>
      <th>Ingresos reales vs Fact</th>
      <th>Diferencia de ingresos fac vs cobrados</th>
    </tr>
    {% for r in registros %}
    <tr>
      <td style="text-align:center;">{{ r.periodo }}</td>
      <td>${{ r.ingresos_mantenimiento|floatformat:2|intcomma }}</td>
      <td>${{ r.dppp|floatformat:2|intcomma }}</td>
      <td>${{ r.ingresos_netos_mantenimiento|floatformat:2|intcomma }}</td>
      <td>${{ r.ingresos_cuota_extraordinaria|floatformat:2|intcomma }}</td>
      <td>${{ r.cuota_ordinaria_retroactiva|floatformat:2|intcomma }}</td>
      <td>${{ r.revision_csau|floatformat:2|intcomma }}</td>
      <td>${{ r.depositos_garantia_obra|floatformat:2|intcomma }}</td>
      <td>${{ r.ingresos_intereses_cuotas|floatformat:2|intcomma }}</td>
      <td>${{ r.ingresos_rendimiento_inversiones|floatformat:2|intcomma }}</td>
      <td>${{ r.sanciones|floatformat:2|intcomma }}</td>
      <td>${{ r.recuperacion_seguro_danios|floatformat:2|intcomma }}</td>
      <td>${{ r.recuperacion_gastos_cobranza|floatformat:2|intcomma }}</td>
      <td>${{ r.depositos_no_identificados|floatformat:2|intcomma }}</td>
      <td>${{ r.total|floatformat:2|intcomma }}</td>
      <td>${{ r.ingresos_reales_vs_fact|floatformat:2|intcomma }}</td>
      <td>${{ r.diferencia_ingresos_fac_vs_cobrados|floatformat:2|intcomma }}</td>
    </tr>
    {% endfor %}
  </table>
</div>
<div>
  <center>Todos los derechos reservados</center>
</div>

<script>
// Toggle sidebar
const sidebar = document.getElementById("sidebar");
const content = document.getElementById("content");
const btnSidebar = document.getElementById("btnSidebar");

btnSidebar.addEventListener("click", () => {
  sidebar.classList.toggle("active");
  content.classList.toggle("shifted");
});

// Cerrar sidebar al click fuera
document.addEventListener("click", (e) => {
  if (!sidebar.contains(e.target) && !btnSidebar.contains(e.target) && sidebar.classList.contains("active")) {
    sidebar.classList.remove("active");
    content.classList.remove("shifted");
  }
});

// Cerrar con Esc
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape" && sidebar.classList.contains("active")) {
    sidebar.classList.remove("active");
    content.classList.remove("shifted");
  }
});
</script>

</body>
</html>
