{% extends "finanzas/base.html" %}
{% load static %}
{% block content %}
{% load humanize %}
<!-- Font Awesome 6 Free (CDN) -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">

<!--  FILTROS  -->
<!-- FILTROS --> <center> <form method="get" action=""> <label>Desde:</label> <select name="inicio"> <option value="">Todos</option> {% for p in periodos %} <option value="{{ p }}" {% if request.GET.inicio == p %}selected{% endif %}>{{ p }}</option> {% endfor %} </select> <label>Hasta:</label> <select name="fin"> <option value="">Todos</option> {% for p in periodos %} <option value="{{ p }}" {% if request.GET.fin == p %}selected{% endif %}>{{ p }}</option> {% endfor %} </select> <button type="submit">Filtrar</button> </form> </center>
<!-- üîπ TARJETAS KPI -->
<div class="kpi-container">
  <div class="kpi-card">
    <h3>% Periodos con D√©ficit 
      <i class="fas fa-circle-info tooltip" data-tooltip="Indica el porcentaje de periodos donde los ingresos cobrados fueron menores a los facturados. 
F√≥rmula: (Periodos con d√©ficit / Total periodos) √ó 100. Entre m√°s bajo sea, mejor consistencia."></i>
    </h3>
    <p>{{ porcentaje_deficit|floatformat:1 }}%</p>
  </div>

  <div class="kpi-card">
    <h3>D√©ficit Acumulado 
      <i class="fas fa-circle-info tooltip" data-tooltip="Suma total de todas las diferencias negativas entre lo facturado y lo cobrado. 
F√≥rmula: Œ£(diferencias negativas). Un valor alto indica p√©rdidas acumuladas."></i>
    </h3>
    <p>${{ deficit_acumulado|floatformat:2|intcomma }}</p>
  </div>

  <div class="kpi-card">
    <h3>Promedio Diferencia (Fact. vs Cobrado)
      <i class="fas fa-circle-info tooltip" data-tooltip="Promedio general de la diferencia entre ingresos facturados y cobrados. 
F√≥rmula: Œ£(Facturado - Cobrado) / N¬∞ de periodos. Cercano a 0 = equilibrio financiero."></i>
    </h3>
    <p>${{ promedio_diferencia|floatformat:2|intcomma }}</p>
  </div>
</div>

<!-- üîπ GR√ÅFICAS -->
<div id="graficas-container">
  <div class="grafica-card">
    <canvas id="graficaBarras"></canvas>
  </div>
  <div class="grafica-card">
    <canvas id="graficaBarrasHorizontales"></canvas>
  </div>
  <div class="grafica-card">
    <canvas id="graficaDiferencia"></canvas>
  </div>
</div>

<!-- üìä SCRIPT DE GR√ÅFICAS -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const registros = JSON.parse('{{ registros_json|safe|escapejs }}');

  // ---- CAMPOS Y ETIQUETAS ----
  const campos = [
    "ingresos_mantenimiento",
    "dppp",
    "ingresos_netos_mantenimiento",
    "ingresos_cuota_extraordinaria",
    "cuota_ordinaria_retroactiva",
    "revision_csau",
    "depositos_garantia_obra",
    "ingresos_intereses_cuotas",
    "ingresos_rendimiento_inversiones",
    "sanciones",
    "recuperacion_seguro_danios",
    "recuperacion_gastos_cobranza",
    "depositos_no_identificados"
  ];
  const etiquetas = [
    "Mantenimiento","DPPP","Netos Mantenimiento","Cuota Extraordinaria","Cuota Retroactiva",
    "Revisi√≥n CSAU","Garant√≠a Obra","Intereses Cuotas","Rendimiento Inversiones",
    "Sanciones","Seguro/Da√±os","Cobranza","No Identificados"
  ];

  // ---- CALCULAR TOTALES ----
  const totales = campos.map(campo => registros.reduce((a,b) => a + (parseFloat(b[campo])||0), 0));

  // ---- DIFERENCIA FACTURADO VS COBRADO ----
  const periodos = registros.map(r => r.periodo);
  const diferencias = registros.map(r => parseFloat(r.diferencia_ingresos_fac_vs_cobrados) || 0);

  // ---- GR√ÅFICA DE BARRAS ----
  new Chart(document.getElementById("graficaBarras"), {
    type: "bar",
    data: {
      labels: etiquetas,
      datasets: [{
        label: "Totales por tipo de ingreso",
        data: totales,
        backgroundColor: "#2563eb"
      }]
    },
    options: {
      responsive: true,
      plugins: {
        title: { display: true, text: "Totales por Categor√≠a" },
        legend: { display: false }
      },
      scales: { y: { beginAtZero: true } }
    }
  });

  // ---- GR√ÅFICA DE BARRAS HORIZONTALES ----
  new Chart(document.getElementById("graficaBarrasHorizontales"), {
    type: "bar",
    data: {
      labels: etiquetas,
      datasets: [{
        label: "Totales por tipo de ingreso",
        data: totales,
        backgroundColor: [
          "#2563eb","#1d4ed8","#3b82f6","#60a5fa","#93c5fd",
          "#eab308","#facc15","#fcd34d","#a3e635","#10b981",
          "#14b8a6","#8b5cf6","#ec4899"
        ]
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      plugins: {
        title: { display: true, text: "Distribuci√≥n Horizontal de Ingresos" },
        legend: { display: false }
      },
      scales: { x: { beginAtZero: true } }
    }
  });

  // ---- GR√ÅFICA DE DIFERENCIAS ----
  const ctxDif = document.getElementById("graficaDiferencia").getContext("2d");

  // Crear degradado vertical suave
  const grad = ctxDif.createLinearGradient(0, 0, 0, ctxDif.canvas.height);
  grad.addColorStop(1, "rgb(255, 0, 0, 0.6)");   // rojo suave
  grad.addColorStop(0.5, "rgb(163, 255, 0, 0.6"); // transici√≥n naranja
  grad.addColorStop(0, "rgb(163, 255, 0, 0.3)");   // verde suave

  new Chart(ctxDif, {
    type: "line",
    data: {
      labels: periodos,
      datasets: [{
        label: "Diferencia Facturado vs Cobrado",
        data: diferencias,
        borderColor: "#3c3c3c",
        backgroundColor: grad,
        tension: 0.3,
        fill: true,
        pointRadius: 4,
        pointHoverRadius: 6
      }]
    },
    options: {
      responsive: true,
      plugins: {
        title: { display: true, text: "Tendencia de Diferencia por Periodo" },
        legend: { display: true }
      },
      scales: { 
        y: { 
          beginAtZero: false,  // permite ver diferencias negativas y positivas
          ticks: { color: "#e5e7eb" } // para modo oscuro se vea
        },
        x: {
          ticks: { color: "#e5e7eb" } // para modo oscuro
        }
      }
    }
  });
});
</script>

<!-- üé® ESTILOS -->
<style>
#graficas-container {
  display: flex;
  gap: 25px;
  margin-top: 40px;
  flex-wrap: nowrap;
  overflow-x: auto;
}

.grafica-card {
  background: white;
  border-radius: 15px;
  padding: 20px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  min-width: 350px;
  flex: 1;
  transition: transform 0.2s;
}
.grafica-card:hover {
  transform: translateY(-4px);
}

/* MODO OSCURO */
.dark-mode #graficas-container .grafica-card {
  background: #1f2937;
  box-shadow: 0 4px 15px rgba(0,0,0,0.5);
}
</style>

<!-- üîπ FORMULARIO PARA A√ëADIR MOVIMIENTOS -->
<h2>A√±adir Movimiento</h2>
<button type="button" class="toggle-btn" onclick="toggleForm()">
  <i class="fas fa-plus"></i> A√±adir Movimiento
</button>

<form method="POST" id="form-movimiento" style="display:none; margin-top:10px;">
  {% csrf_token %}
  <p>{{ form.periodo.label_tag }} {{ form.periodo }}</p>
  
  <p class="toggle" onclick="document.getElementById('nuevo-periodo').style.display = 
       document.getElementById('nuevo-periodo').style.display === 'none' ? 'block' : 'none'">
    <i class="fas fa-calendar-plus"></i> Nuevo periodo
  </p>
  <div id="nuevo-periodo" style="display:none; margin-left:15px;">
    <p>{{ form.nuevo_periodo.label_tag }} {{ form.nuevo_periodo }}</p>
  </div>
  
  <p>{{ form.columna.label_tag }} {{ form.columna }}</p>
  <p>{{ form.monto.label_tag }} {{ form.monto }}</p>
  <button type="submit" name="a√±adir"><i class="fas fa-plus"></i> A√±adir</button>
</form>

<p style="color:green;">{{ mensaje }}</p>

<script>
function toggleForm() {
  const form = document.getElementById('form-movimiento');
  form.style.display = (form.style.display === 'none' ? 'block' : 'none');
}
</script>

<style>
.toggle-btn {
  background: #2563eb;
  color: white;
  border: none;
  padding: 8px 14px;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.3s;
}
.toggle-btn:hover {
  background: #1d4ed8;
}
</style>

<!-- üîπ FORMULARIO PARA REPORTE -->
<h2>Generar Reporte Excel</h2>
<form method="POST">
  {% csrf_token %}
  <label>Inicio:</label>
  <select name="inicio" required>
    {% for p in periodos %}<option>{{ p }}</option>{% endfor %}
  </select>
  <label>Fin:</label>
  <select name="fin" required>
    {% for p in periodos %}<option>{{ p }}</option>{% endfor %}
  </select>
  <button type="submit" name="generar_reporte"><i class="fas fa-file-excel"></i> Descargar</button>
</form>

<!-- üîπ TABLA DE REGISTROS -->
<h2>Registros Actuales</h2>
<div class="table-container">
  <table>
    <tr>
      <th>Periodo</th>
      <th>Ingresos x Mant.</th>
      <th>DPPP</th>
      <th>Ingresos Netos x Mant.</th>
      <th>Ingreso x Cuota Extr.</th>
      <th>Cuota ordinaria retroactiva</th>
      <th>Revision CSAU</th>
      <th>Dep√≥sitos en garantia de obra</th>
      <th>Ingresos x Intereses de Cuotas</th>
      <th>Ingresos x Rend. Inv.</th>
      <th>Sanciones</th>
      <th>Recuperaci√≥n de Seguro/da√±os</th>
      <th>Recuperaci√≥n de gastos por Cobranza via legal</th>
      <th>Depositos no Identif.</th>
      <th>Total</th>
      <th>Ingresos reales vs Fact</th>
      <th>Diferencia de ingresos fac vs cobrados</th>
    </tr>
    {% for r in registros %}
    <tr>
      <td style="text-align:center;">{{ r.periodo }}</td>
      <td>${{ r.ingresos_mantenimiento|floatformat:2|intcomma }}</td>
      <td>${{ r.dppp|floatformat:2|intcomma }}</td>
      <td>${{ r.ingresos_netos_mantenimiento|floatformat:2|intcomma }}</td>
      <td>${{ r.ingresos_cuota_extraordinaria|floatformat:2|intcomma }}</td>
      <td>${{ r.cuota_ordinaria_retroactiva|floatformat:2|intcomma }}</td>
      <td>${{ r.revision_csau|floatformat:2|intcomma }}</td>
      <td>${{ r.depositos_garantia_obra|floatformat:2|intcomma }}</td>
      <td>${{ r.ingresos_intereses_cuotas|floatformat:2|intcomma }}</td>
      <td>${{ r.ingresos_rendimiento_inversiones|floatformat:2|intcomma }}</td>
      <td>${{ r.sanciones|floatformat:2|intcomma }}</td>
      <td>${{ r.recuperacion_seguro_danios|floatformat:2|intcomma }}</td>
      <td>${{ r.recuperacion_gastos_cobranza|floatformat:2|intcomma }}</td>
      <td>${{ r.depositos_no_identificados|floatformat:2|intcomma }}</td>
      <td>${{ r.total|floatformat:2|intcomma }}</td>
      <td>${{ r.ingresos_reales_vs_fact|floatformat:2|intcomma }}</td>
      <td>${{ r.diferencia_ingresos_fac_vs_cobrados|floatformat:2|intcomma }}</td>
      <td>
        <!-- Formulario editar -->
        <form method="POST" style="display:inline;">
          {% csrf_token %}
          <input type="hidden" name="id_registro" value="{{ r.id }}">
          <select name="columna" required>
            <option value="ingresos_mantenimiento">Ingresos x Mant.</option>
            <option value="dppp">DPPP</option>
            <option value="ingresos_netos_mantenimiento">Ingresos Netos</option>
            <option value="ingresos_cuota_extraordinaria">Ingreso x Cuota Extr.</option>
            <option value="cuota_ordinaria_retroactiva">Cuota Retroactiva</option>
            <option value="revision_csau">Revision CSAU</option>
            <option value="depositos_garantia_obra">Depositos Garant√≠a</option>
            <option value="ingresos_intereses_cuotas">Ingresos Intereses</option>
            <option value="ingresos_rendimiento_inversiones">Ingresos Rend. Inv.</option>
            <option value="sanciones">Sanciones</option>
            <option value="recuperacion_seguro_danios">Recuperaci√≥n Seguro/Da√±os</option>
            <option value="recuperacion_gastos_cobranza">Cobranza Legal</option>
            <option value="depositos_no_identificados">Depositos No Identif.</option>
          </select>
          <input type="number" step="0.01" name="nuevo_valor" placeholder="Nuevo valor" required>
          <button type="submit" name="editar" title="Editar"><i class="fas fa-edit"></i></button>
        </form>

        <!-- Formulario eliminar -->
        <form method="POST" style="display:inline;">
          {% csrf_token %}
          <input type="hidden" name="id_registro" value="{{ r.id }}">
          <button type="submit" name="eliminar" onclick="return confirm('¬øEliminar este registro?');" title="Eliminar">
            <i class="fas fa-trash"></i>
          </button>
        </form>
      </td>
    </tr>
    {% endfor %}
  </table>
</div>
<div>
  <center>Todos los derechos reservados</center>
</div>

<script>
// Toggle sidebar
const sidebar = document.getElementById("sidebar");
const content = document.getElementById("content");
const btnSidebar = document.getElementById("btnSidebar");

btnSidebar.addEventListener("click", () => {
  sidebar.classList.toggle("active");
  content.classList.toggle("shifted");
});

// Cerrar sidebar al click fuera
document.addEventListener("click", (e) => {
  if (!sidebar.contains(e.target) && !btnSidebar.contains(e.target) && sidebar.classList.contains("active")) {
    sidebar.classList.remove("active");
    content.classList.remove("shifted");
  }
});

// Cerrar con Esc
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape" && sidebar.classList.contains("active")) {
    sidebar.classList.remove("active");
    content.classList.remove("shifted");
  }
});
</script>
{% endblock %}